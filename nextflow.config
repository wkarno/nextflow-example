/*
========================================================================================
    Nextflow Configuration File
========================================================================================
*/

// Default parameters - can be overridden by params.yaml or command line
params {
    // Input/Output
    samplesheet = "$projectDir/samplesheet.csv"
    outdir = "$projectDir/results"

    // Reference genome
    reference = null  // Must be specified by user

    // FastP trimming parameters
    fastp_qualified_quality = 20
    fastp_min_length = 50
    fastp_cut_mean_quality = 20
    fastp_extra_args = ""

    // BWA-MEM parameters
    bwa_extra_args = ""

    // QC cutoffs (for interpretation - not enforced in pipeline)
    min_reads_after_trimming = 1000000
    min_mapping_rate = 0.80
    max_duplicate_rate = 0.30

    // Resource defaults
    max_cpus = 8
    max_memory = '32.GB'
    max_time = '24.h'

    // Help message
    help = false
}

// Process configuration
process {
    // Error handling
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries = 2

    // Docker is enabled by default
    container = null

    // Resource labels
    withLabel: process_low {
        cpus = { check_max( 2, 'cpus' ) }
        memory = { check_max( 4.GB * task.attempt, 'memory' ) }
        time = { check_max( 2.h * task.attempt, 'time' ) }
    }

    withLabel: process_medium {
        cpus = { check_max( 4, 'cpus' ) }
        memory = { check_max( 8.GB * task.attempt, 'memory' ) }
        time = { check_max( 4.h * task.attempt, 'time' ) }
    }

    withLabel: process_high {
        cpus = { check_max( 8, 'cpus' ) }
        memory = { check_max( 16.GB * task.attempt, 'memory' ) }
        time = { check_max( 8.h * task.attempt, 'time' ) }
    }

    // Process-specific resources
    withName: FASTQC_RAW {
        cpus = 2
        memory = '4.GB'
    }

    withName: FASTP {
        cpus = 4
        memory = '8.GB'
    }

    withName: FASTQC_TRIMMED {
        cpus = 2
        memory = '4.GB'
    }

    withName: BWA_INDEX {
        cpus = 1
        memory = '8.GB'
    }

    withName: BWA_MEM {
        cpus = 8
        memory = '16.GB'
        time = '8.h'
    }

    withName: SORT_BAM {
        cpus = 4
        memory = '8.GB'
    }

    withName: ALIGNMENT_STATS {
        cpus = 2
        memory = '4.GB'
    }

    withName: MULTIQC {
        cpus = 1
        memory = '4.GB'
    }
}

// Docker configuration
docker {
    enabled = true
    runOptions = '-u $(id -u):$(id -g)'
    fixOwnership = true
    temp = 'auto'
}

// Execution profiles
profiles {
    docker {
        docker.enabled = true
        singularity.enabled = false
    }

    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        docker.enabled = false
    }

    local {
        executor.name = 'local'
        executor.cpus = params.max_cpus
        executor.memory = params.max_memory
    }

    slurm {
        executor.name = 'slurm'
        executor.queueSize = 50
        executor.submitRateLimit = '10 sec'
    }

    sge {
        executor.name = 'sge'
        executor.queueSize = 50
    }

    lsf {
        executor.name = 'lsf'
        executor.queueSize = 50
    }

    pbs {
        executor.name = 'pbs'
        executor.queueSize = 50
    }

    test {
        // Quick test profile with reduced resources
        params.max_cpus = 2
        params.max_memory = '4.GB'
        params.max_time = '1.h'
    }
}

// Manifest
manifest {
    name = 'FASTQ Processing Pipeline'
    author = 'Your Name'
    homePage = 'https://github.com/yourusername/nextflow-fastq-pipeline'
    description = 'Pipeline for processing FASTQ files: QC, trimming, and alignment'
    mainScript = 'main.nf'
    nextflowVersion = '>=21.10.0'
    version = '1.0.0'
}

// Report configuration
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/timeline.html"
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/report.html"
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/trace.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/dag.svg"
}

// Function to check maximum resources
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "ERROR: invalid value for max_memory: ${params.max_memory}"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "ERROR: invalid value for max_time: ${params.max_time}"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min(obj, params.max_cpus as int)
        } catch (all) {
            println "ERROR: invalid value for max_cpus: ${params.max_cpus}"
            return obj
        }
    }
}
